meta:
  name: Children's Story Video
  description: Generate animated children's story videos with consistent characters, narration, and music.
  id: ChildrenStory
  version: 0.1.0
  author: Renku
  license: MIT

inputs:
  - name: StoryDescription
    description: The main description of what the children's story should be about.
    type: string
    required: true
  - name: NumOfCharacters
    description: Number of main characters (1-4).
    type: int
    required: true
  - name: Style
    description: Visual style (e.g., colorful cartoon, watercolor, 3D animation).
    type: string
    required: true
  - name: AgeGroup
    description: Target age group (e.g., 3-5 years, 6-8 years).
    type: string
    required: true
  - name: VoiceId
    description: Voice identifier for the narrator.
    type: string
    required: true
  - name: AspectRatio
    description: Aspect ratio (16:9, 9:16, 1:1).
    type: string
  - name: Resolution
    description: Video resolution (720p, 1080p).
    type: string

artifacts:
  - name: Character1Image
    description: Generated image for character 1.
    type: image
  - name: Character2Image
    description: Generated image for character 2.
    type: image
  - name: Character3Image
    description: Generated image for character 3.
    type: image
  - name: Character4Image
    description: Generated image for character 4.
    type: image
  - name: SegmentVideo
    description: Generated video segments.
    type: array
    itemType: video
  - name: SegmentAudio
    description: Generated narration audio per segment.
    type: array
    itemType: audio
  - name: BackgroundMusic
    description: Generated background music.
    type: audio
  - name: Timeline
    description: Composed timeline JSON.
    type: json

loops:
  - name: segment
    countInput: NumOfSegments

producers:
  - name: StoryProducer
    producer: prompt/children-story
  # Always generate all 4 character images
  - name: Character1ImageProducer
    producer: asset/text-to-image
  - name: Character2ImageProducer
    producer: asset/text-to-image
  - name: Character3ImageProducer
    producer: asset/text-to-image
  - name: Character4ImageProducer
    producer: asset/text-to-image
  - name: SceneVideoProducer
    producer: asset/reference-to-video
    loop: segment
  - name: NarrationProducer
    producer: asset/text-to-speech
    loop: segment
  - name: MusicProducer
    producer: asset/text-to-music
  - name: TimelineComposer
    producer: composition/timeline-composer

# Per-segment conditions for which characters appear in each scene
conditions:
  char1InSegment:
    when: StoryProducer.StoryScript.Segments[segment].Character1InScene
    is: true
  char2InSegment:
    when: StoryProducer.StoryScript.Segments[segment].Character2InScene
    is: true
  char3InSegment:
    when: StoryProducer.StoryScript.Segments[segment].Character3InScene
    is: true
  char4InSegment:
    when: StoryProducer.StoryScript.Segments[segment].Character4InScene
    is: true

connections:
  # --- Inputs to StoryProducer ---
  - from: StoryDescription
    to: StoryProducer.StoryDescription
  - from: Duration
    to: StoryProducer.Duration
  - from: NumOfSegments
    to: StoryProducer.NumOfSegments
  - from: NumOfCharacters
    to: StoryProducer.NumOfCharacters
  - from: Style
    to: StoryProducer.Style
  - from: AgeGroup
    to: StoryProducer.AgeGroup

  # --- Character 1 Image Generation (always) ---
  - from: StoryProducer.StoryScript.Character1ImagePrompt
    to: Character1ImageProducer.Prompt
  - from: AspectRatio
    to: Character1ImageProducer.AspectRatio
  - from: Character1ImageProducer.GeneratedImage
    to: Character1Image

  # --- Character 2 Image Generation (always) ---
  - from: StoryProducer.StoryScript.Character2ImagePrompt
    to: Character2ImageProducer.Prompt
  - from: AspectRatio
    to: Character2ImageProducer.AspectRatio
  - from: Character2ImageProducer.GeneratedImage
    to: Character2Image

  # --- Character 3 Image Generation (always) ---
  - from: StoryProducer.StoryScript.Character3ImagePrompt
    to: Character3ImageProducer.Prompt
  - from: AspectRatio
    to: Character3ImageProducer.AspectRatio
  - from: Character3ImageProducer.GeneratedImage
    to: Character3Image

  # --- Character 4 Image Generation (always) ---
  - from: StoryProducer.StoryScript.Character4ImagePrompt
    to: Character4ImageProducer.Prompt
  - from: AspectRatio
    to: Character4ImageProducer.AspectRatio
  - from: Character4ImageProducer.GeneratedImage
    to: Character4Image

  # --- Scene Video Generation ---
  - from: StoryProducer.StoryScript.Segments[segment].ScenePrompt
    to: SceneVideoProducer[segment].Prompt
  - from: Resolution
    to: SceneVideoProducer[segment].Resolution
  - from: AspectRatio
    to: SceneVideoProducer[segment].AspectRatio
  - from: SegmentDuration
    to: SceneVideoProducer[segment].Duration

  # Pass character images as references ONLY when that character is in the scene
  - from: Character1ImageProducer.GeneratedImage
    to: SceneVideoProducer[segment].ReferenceImages[0]
    if: char1InSegment
  - from: Character2ImageProducer.GeneratedImage
    to: SceneVideoProducer[segment].ReferenceImages[1]
    if: char2InSegment
  - from: Character3ImageProducer.GeneratedImage
    to: SceneVideoProducer[segment].ReferenceImages[2]
    if: char3InSegment
  - from: Character4ImageProducer.GeneratedImage
    to: SceneVideoProducer[segment].ReferenceImages[3]
    if: char4InSegment

  - from: SceneVideoProducer[segment].GeneratedVideo
    to: SegmentVideo[segment]

  # --- Narration Audio Generation ---
  - from: StoryProducer.StoryScript.Segments[segment].NarrationText
    to: NarrationProducer[segment].Text
  - from: VoiceId
    to: NarrationProducer[segment].VoiceId
  - from: NarrationProducer[segment].GeneratedAudio
    to: SegmentAudio[segment]

  # --- Background Music Generation ---
  - from: StoryProducer.StoryScript.MusicPrompt
    to: MusicProducer.Prompt
  - from: Duration
    to: MusicProducer.Duration
  - from: MusicProducer.GeneratedMusic
    to: BackgroundMusic

  # --- Timeline Composition ---
  - from: SceneVideoProducer[segment].GeneratedVideo
    to: TimelineComposer.VideoSegments
  - from: NarrationProducer[segment].GeneratedAudio
    to: TimelineComposer.AudioSegments
  - from: MusicProducer.GeneratedMusic
    to: TimelineComposer.Music
  - from: Duration
    to: TimelineComposer.Duration
  - from: TimelineComposer.Timeline
    to: Timeline

collectors:
  # Collect videos for timeline
  - name: TimelineVideos
    from: SceneVideoProducer[segment].GeneratedVideo
    into: TimelineComposer.VideoSegments
    groupBy: segment
  # Collect audio for timeline
  - name: TimelineAudio
    from: NarrationProducer[segment].GeneratedAudio
    into: TimelineComposer.AudioSegments
    groupBy: segment
